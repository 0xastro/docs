---
id: docker-integration
sidebar_label: Docker Integration
slug: /mine-hnt/full-hotspots/become-a-maker/docker-integration
---

# Docker Integration

import useBaseUrl from "@docusaurus/useBaseUrl";

We generally recommend that Makers use Docker for running Miner. This allows you
to pull images from
[Helium's Quay repository](https://quay.io/repository/team-helium/miner?tab=tags)
and avoids the need to maintain your own Miner build & release pipeline along
with all of Miner's system dependencies, such as Erlang.

If you prefer, you _can_
[build Miner from source](https://github.com/helium/miner), but this guide is
for those that are running the Docker image.

## The Docker Release Process

Before we get into the details, it's useful to understand how the Quay releases
integrate with the Miner release flow.

Helium maintains the [Miner repository](https://github.com/helium/miner) and
maintains proprietary firmware images for the original Helium Hotspots
(Raspberry Pi 3B+ and 4 based). When we have a release candidate, you will see a
tag with the date of the release candidate. This usually means that we are
testing a release candidate. This testing process has many stages, but if and
when a release passes, it will graduate to "General Availability" and be
re-tagged with the `_GA` suffix. This triggers an automatic build of the Docker
images which get pushed to Quay when complete.

In addition, a "Blockchain Release" will typically be posted on
[engineering.helium.com](https://engineering.helium.com/).

As a blockchain is decentralized in its nature, we are careful not to do
breaking changes that require immediate and synchronized updates of the Miner.

When breaking changes need to be deployed, they tend to be gated by a "chain
variable" (aka `chainvar`) which signals to the Miners that the new behavior is
to take affect. Only when this chain variable is activated do stale Miners stop
working.

:::info

It is highly recommended that Makers automate the process by checking the Quay
repository for `_GA` tags every half hour, and plan on deploying at least once a
day in case there are emergency releases.

:::

## Initial Testing of the Docker on Your Host System

The Docker image is tailored to be able to run very simply at first, but will
generally require additional customization to integrate well with your host
system.

Start by following
[these instructions](/mine-hnt/full-hotspots/become-a-maker/basic-miner-operation).
If that ends up being no problem, then you're doing great! The extra sections in
this guide will discuss things you should do when preparing a production system
for the Miner container.

## The LoRa Packet Forwarder

Integrating the miner process with the LoRa packet forwarder requires some
finess. The packet forwarder must be configured properly so that it operates
using the unique LoRa parameters for the geographical region in which the
hotspot is asserted. To do this, your integration must ask the miner for
the appropriate LoRa parameters to use and then launch the packet forwarder
with those parameters.

We will describe two methods for setting up the packet forwarder: one for
initial testing, and a second, proper method, which must be used in
production.

### Forcing the LoRa Region With an Override

During initial testing you may wish to tell the miner to override the local
region settings so that you can launch the packet forwarder immediately without
consulting the blockchain for parameters. To do this you use the
`REGION_OVERRIDE` environment variable.

Setting `REGION_OVERRIDE` allows you to forward packets without being asserted
on-chain (ie: they will not earn HNT). As stated before, using the override
in a _production_ system is detrimental. It will lock the device into the
region you specify, which may not be acceptable for the blockchain.

### Fetching the LoRa Region and Parameters at Runtime

In production, all proper deployments _must_ query the miner to:

* Obtain the LoRa Region name (e.g. `AS923_1`),
* Launch the packet forwarder with the proper LoRa parameters.

This process must be followed not only at boot time, but also continuously
throughout the hotspot's running lifetime because some or all of the
parameters may change.

* The hotspot's location, and thus the LoRa region in which it operates
  may change because the hotspot owner has established or moved
  the hotspot via an `assert_location` transaction.

* The region parameters themselves may change due government regulations or
  community decisions.

:::info
See additional notes about what to do if the asserted location is not supported
by your hardware or certification process.
:::

The general procedure, in psuedo-code is:

1. Poll the miner process to determine the local LoRa region. Wait until it
   changes (or at boot, is established.)
2. On region change/availability, ask the miner for the LoRa parameters for
   the region.
3. Use the parameters to find, or generate, a packet forwarder configuration
   that matches the parameters.
4. Launch (or restart) the packet forwarder with the correct configuration.
5. Repeat at step 1.

#### Polling the Miner for the LoRa Region

There are two methods you can use to poll the miner for its configured region:
the command-line interface and via JSON-RPC.

*Command-line Polling*

```bash
# Wait until miner knows the regulatory region.
while ! REGION=$( /opt/miner/bin/miner info region); do
    sleep 30
done
```

*JSON-RPC Polling*

```bash
while ! REGION=$( \
    curl -s http://localhost:4467/ \
        -d '{"jsonrpc":"2.0","id":0,"method":"info_region"}' | \
        jq -e -r .result); do
    sleep 30
done
```

#### Querying the Miner for LoRa parameters

The LoRa parameters for a geographical region are highly-structured data. For
this reason, you must use the miner JSON-RPC interface to query and receive
them.

*JSON-RPC Query*

```bash
curl -s http://localhost:4467/ \
    -d '{"jsonrpc":"2.0","id":0,"method":"ledger_lora_region_parameters","params":{"region":"'"$REGION"'""}}'
```

The result from this query, should it succeed, will be a JSON object. The
object contained within the `.result` attribute will be an array of Channel
objects representing the LoRa uplink channels used in the region.

*Channel Object*

|Attribute|JSON type|Description|
|-|-|-|
|`channel_frequency_hz`|number|Channel center frequency, in hertz.|
|`bandwidth_hz` | number | Channel bandwidth, in hertz.|
|`max_eirp_dbm` | number | Maximum permissible Effective Isotropic Radiated Power (EIRP), in deciBels milliwatt (dBm).|
|`spreading` | array | List of spreading factors used on the channel and their maximum packet sizes. (See SpreadingFactor object).|

*SpreadingFactor object*

|Attribute|JSON type|Description|
|-|-|-|
|`factor` | string | Enumeration (one of) `SF12`, `SF11`, `SF10`, `SF9`, `SF8`, `SF7`; representing a LoRa spreading factor.|
|`max_packet_size` | number | Maximum permissible transmit packet size at this spreading factor, in bytes.|

:::info
If you need examples of our regional packet forwarder configurations, please see
[here](https://github.com/helium/sx1302_hal/tree/helium/hotspot/packet_forwarder).
:::

:::warning
If you are using our packet forwarder, be sure to customize the `rssi_offset`
field for your particular concentrator design. Misconfiguring this value may
result in decreased Proof-of-Coverage performance for your customers.
:::

## Enable ECC608 and D-Bus

Miner has
[a configuration file](https://github.com/helium/miner/blob/master/config/sys.config)
which exposes many useful variables. For example, Helium uses this to configure
the
"[blessed snapshot](https://github.com/helium/miner/blob/master/config/sys.config#L37)"
in our firmware which enables Miners to quickly sync their ledger to the height
of the most recent snapshots. You benefit from this automatically when you use
our Docker files.

However, our Docker images also disable the ECC608 and dbus by default. If you
are using the ECC608 and use the BLE for setting up the hotspots, you need to
re-anble them.

The default Docker overrides are seen
[here](https://github.com/helium/miner/blob/master/config/docker.config). We do
a few things that make the image more portable, such as disabling D-bus
(`{use_ebus, false}`) and the ECC608 (`{key, undefined}`).

As a Hotspot vendor using Docker, you will want to revert these `sys.config`
overrides by simply deleting them. You can do this in a way that persists over
Docker updates by maintaining your own configuration file outside of the Docker
(similar to what we do with `/var/data/`).

For example, you can create a directory called "overlay" and copy
[the default override](https://github.com/helium/miner/blob/master/config/docker.config).
You now you will have `~/overlay/docker.config`.

Delete the D-bus line (`{use_ebus, false}`) and the ECC608 line
(`{key, undefined}`) and the behavior will revert to that in
[the main configuration file](https://github.com/helium/miner/blob/master/config/sys.config)
where these are enabled.

You will also want to add a few arguments to your Docker run command which
create the extra mount point for the config, connect the i2c-device to the
Docker container, and connect D-bus to the Docker container. For example:

```bash
 --device /dev/i2c-1 \
 --net host \
 --privileged \
 -v /var/run/dbus:/var/run/dbus \
 --mount type=bind,source=/home/ubuntu/overlay/docker.config,target=/config/sys.config
```

## Define the DBus Config

You'll want to install
[the Miner's DBus config](https://github.com/helium/miner/blob/master/config/com.helium.Miner.conf),
typically at: `/etc/dbus-1/system.d/com.helium.Miner.conf`

## Setting the ulimit

Ensure the ulimit system is set to a *minimum* of `64000`; anything lower will be insufficient but more is welcome.

You'll want to include the Docker run argument `--ulimit nofile=64000:64000`.

**In addition**, you'll need to verify that your Linux system allows for such file limits. For example,

```bash
$ ulimit -Sn
64000
```

If the host system does not allow for 64,000 file handles, then the `docker run` argument will not be sufficient.

